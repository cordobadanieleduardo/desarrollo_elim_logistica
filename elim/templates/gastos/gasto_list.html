{% extends 'base/base.html' %}
{% block page_content %}
{% load humanize %}
<div class="card shadow mb-4">
    <!-- Card Header - Dropdown -->
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">Gastos del vehiculo</h6>
        <div class="dropdown no-arrow">
            <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                <div class="dropdown-header">Acciones:</div>
                <a class="dropdown-item" href="{% url 'elim:gasto_new' %}">
                    <i class="far fa-calendar-plus"></i> Nuevo</a>
            </div>
        </div>
    </div>
    <!-- Card Body -->
    <div class="card-body">
        <div class="titleholder">
            <!-- <div class="title text-uppercase"> Vehiculos Elim Logística</div> -->
            <!-- <div class="title"> {% if location %} para {{location.direccion}} ({{label}}) {% endif %}</div>  -->
        </div>

        <!-- Card menu -->
        <div class="alert alert-info">
            <a class="btn btn-default" href="{% url 'elim:gasto_new' %}" > Registrar gasto </a>
            <!-- <a class="btn btn-default" onclick="return abrir_modal('{% url 'elim:reg_new' %}')" href="#"> Nuevo servicio</a> -->
            <!-- <a class="btn btn-default" onclick="return abrir_modal('{% url 'elim:vehiculo_new' %}')" href="#"> Nuevo vehiculo</a> -->
            <!-- <a class="btn btn-default" href="{% url 'elim:reg_direccion_new' %}"> Direcciones</a> -->
            <!-- <a class="btn btn-default" href="{% url 'elim:vehiculo_list' %}"> Vehiculos</a>       -->
        </div>
        {% if not obj %}
        <div class="alert alert-info"> Ningún gasto conductor disponible </div>
        {% endif %}
        <table id="table" class="table table-striped table-hover dt-responsive nowrap">
            <thead>
                <th class="all"> Id</th>                
                <th class="all"> Acciones</th>
                <th>Fecha</th>                
                <th>Estado</th>                
                <th>Concepto</th>
                <th>Medio de pago</th>
                <th>N° Factura</th>
                <th>Total</th>
                <th>Efectivo</th>
                <th>Crédito</th>
                <th>Transferencia</th>
                <th>Descripción</th>
            </thead>
            <tbody id="tableBody_programmers">
            </tbody>
            <tfoot>
                <!-- <tr>
                    <th colspan="4" style="text-align:left" >Total:<div id="id_total">0.0</div> </th>
                    <th></th>
                </tr> -->
            </tfoot>
        </table>        
    </div>
</div>

{% endblock %}
{% block js_page %}
<script>
    $(document).ready(function () {
        $("#sidebarToggle").click();
    });

    let dataTable;
    let dataTableIsInitialized = false;
    const dataTableOptions = {
        columnDefs: [
            { className: "centered", targets: [0, 1, 2, 3, 4, 5, 6] },
            { orderable: false, targets: [0] },
            { searchable: false, targets: [0] }
        ],
        pageLength: 10,
        destroy: true,
        "stateSave": true,
        "scrollCollapse": false,
        "scrollY": '300px',
        "scrollX": true,
        "responsive": true,
        "processing": true,
        "dom": 'Blfrtip',
        "language": {
            "decimal": ',',
            "thousands": '.',
            "sProcessing": "Procesando...",
            "sLengthMenu": "Mostrar _MENU_ registros",
            "sZeroRecords": "No se encontraron resultados",
            "sEmptyTable": "Ningún dato disponible en esta tabla",
            "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
            "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
            "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
            "sInfoPostFix": "",
            "sSearch": "Buscar:",
            "sUrl": "",
            "sInfoThousands": ",",
            "sLoadingRecords": "Cargando...",
            "oPaginate": {
                "sFirst": "<span class='fa fa-angle-double-left'></span>",
                "sLast": "<span class='fa fa-angle-double-right'></span>",
                "sNext": "<span class='fa fa-angle-right'></span>",
                "sPrevious": "<span class='fa fa-angle-left'></span>"
            },
            "oAria": {
                "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                "sSortDescending": ": Activar para ordenar la columna de manera descendente"
            }
        },
    };

    const initDataTable = async () => {
        if (dataTableIsInitialized) {
            dataTable.destroy();
        }
        await listProgrammers();
        dataTable = $("#table").DataTable(dataTableOptions);
        dataTableIsInitialized = true;
    };

    const listProgrammers = async () => {
        try {
            const response = await fetch("{% url 'api:gastos_list_reload' %}");
            const data = await response.json();
            let content = ``;
            data.data.forEach((item, index) => {
                content += `
                <tr>
                    <td>${item.id}</td>
                    <td>
                        <a href="/elim/gastos/edit/${item.id}"> <i class="far fa-edit"></i> </a>
                        <a href="#" onclick="return abrir_modal('/elim/gastos/detail/${item.id}')">Imagen</a>
                    </td>
                    <td>${luxon.DateTime.fromISO(item.fecha).setLocale('co').toFormat('F')}</td>
                    <td>${item.estado_aceptacion == true ? 'Aceptado' : item.estado_aceptacion == false ? 'Rechazado' : 'Por revisar'}</td>
                    <td>${item.concepto}</td>
                    <td>${item.medio_pago}</td>
                    <td>${item.factura}</td>
                    <td>
                        <span style='color: ${item.color};'>  
                            ${Number((item.valor).replace(',', '.')).toLocaleString()} 
                        </span>                        
                    </td>
                    <td>${Number((item.efectivo).replace(',', '.')).toLocaleString()}</td>
                    <td>${Number((item.credito).replace(',', '.')).toLocaleString()}</td>
                    <td>${Number((item.transferencia).replace(',', '.')).toLocaleString()}</td>
                    <td>${item.descripcion}</td>
                    
                </tr>`;
            });
            tableBody_programmers.innerHTML = content;
        } catch (ex) {
            alert(ex);
        }
    };

    window.addEventListener("load", async () => {
        await initDataTable();
    });
</script>
{% endblock %}